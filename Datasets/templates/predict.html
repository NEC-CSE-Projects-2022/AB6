{% extends "base.html" %}
{% block title %}Prediction â€¢ Plant Disease Detector{% endblock %}

{% block content %}

<!-- ================= Upload Section ================= -->
<section class="card">
  <h2>Prediction</h2>

  <form method="POST" enctype="multipart/form-data">

    <label class="label">Upload leaf images</label>

    <div class="drop">
      <p><strong>Drag & drop</strong> images here or</p>

      <!-- FILES: single + multiple -->
      <input id="file"
            name="file"
            type="file"
            accept="image/*"
            multiple
            hidden>

<!-- FOLDER: folder only -->
      <input id="folder"
            name="file"
            type="file"
            accept="image/*"
            multiple
            webkitdirectory
            directory
            hidden>


      <button type="button" class="btn-primary"
              onclick="document.getElementById('file').click()">
        Choose files
      </button>
      <button type="button" class="btn"
        onclick="document.getElementById('folder').click()">
        Choose folder
      </button>
      <p id="fileName" class="hint"></p>
    </div>

    <div class="actions">
      <button class="btn-primary" type="submit">Predict</button>
      <button type="button" class="btn" onclick="resetPreview()">Clear</button>
    </div>

  </form>
</section>



<!-- ================= Results Section ================= -->
<section class="card">
  <h3>Results</h3>

  <div class="result-grid">

    {% if results %}
      {% for item in results %}
      <div class="result-card">

        <img src="{{ item.image }}" class="result-img">

        <div class="result-text">
          {{ item.result }}
        </div>

        <!-- ðŸ”¥ Download button -->
        <button class="btn-primary"
          onclick="downloadImage('{{ item.image }}',
                                 'result_{{ loop.index }}.jpg',
                                 '{{ item.result }}')">
          Download JPG
        </button>

      </div>
      {% endfor %}
    {% else %}
      <p class="hint">Upload images to see predictions</p>
    {% endif %}

  </div>
</section>

{% endblock %}



{% block scripts %}
<script>

const fileInput = document.getElementById("file");
const folderInput = document.getElementById("folder");
const fileName = document.getElementById("fileName");

function updateCount() {
  const files = [
    ...Array.from(fileInput.files || []),
    ...Array.from(folderInput.files || [])
  ];
  if (!files.length) return;
  fileName.textContent = `${files.length} image(s) selected`;
}

fileInput.addEventListener("change", updateCount);
folderInput.addEventListener("change", updateCount);

function resetPreview() {
  fileInput.value = "";
  folderInput.value = "";
  fileName.textContent = "";
}


/* ================= Clear ================= */
function resetPreview() {
  fileInput.value = "";
  fileName.textContent = "";
}


/* =====================================================
   ðŸ”¥ DOWNLOAD WITH CONFIDENCE TEXT INCLUDED
   (canvas method)
===================================================== */
function downloadImage(dataUrl, filename, text) {

  const img = new Image();

  img.onload = function () {

    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");

    const padding = 70;

    canvas.width = img.width;
    canvas.height = img.height + padding;

    /* white background */
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    /* draw image */
    ctx.drawImage(img, 0, 0);

    /* draw text */
    ctx.fillStyle = "#000";
    ctx.font = "20px Arial";
    ctx.textAlign = "center";

    ctx.fillText(text, canvas.width / 2, img.height + 40);

    /* convert to JPG */
    const finalImage = canvas.toDataURL("image/jpeg", 0.95);

    const link = document.createElement("a");
    link.href = finalImage;
    link.download = filename;
    link.click();
  };

  img.src = dataUrl;
}

</script>



<style>

/* ================= Grid Layout ================= */
.result-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
  gap: 18px;
}

/* card */
.result-card {
  background: #fff;
  border: 1px solid #e5e7eb;
  border-radius: 14px;
  padding: 14px;
  text-align: center;
  box-shadow: 0 8px 20px rgba(0,0,0,.06);
}

/* image */
.result-img {
  max-width: 100%;
  border-radius: 10px;
  margin-bottom: 10px;
}

/* result text */
.result-text {
  margin-bottom: 10px;
  font-weight: 600;
}

</style>

{% endblock %}
